<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>elixir 之宏 | 独钓寒江雪</title>

  
  <meta name="author" content="John Doe" />
   
  <meta
    name="description"
    content="关键字require1导入宏, 否则不能调用宏的方法

use给模块动态增加方法
相当于
12require XXXXXX.__using__

quote生成当前表达式的语法树，必须要在 defmacro 语句的里面才能用
unquote说明
1把 语法树转换为实际表达式，一般和 `quote` " />
    
  <meta name="keywords" content="elixir"> 

  <meta
    id="viewport"
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  
  <meta property="og:title" content="elixir 之宏" />
  

  <meta property="og:site_name" content="独钓寒江雪" />

  
  <meta property="og:image" content="/favicon.ico" />
  

  <link href="/favicon.ico" rel="icon" />
  <link
    rel="alternate"
    href="/atom.xml"
    title="独钓寒江雪"
    type="application/atom+xml" />
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css" />

  <script
    async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9313450459437229"
    crossorigin="anonymous"></script>
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">独钓寒江雪</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/tags">标签</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>elixir 之宏</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2025/12/08/elixir-marco/" rel="bookmark">
        <time class="entry-date published" datetime="2025-12-08T00:37:41.000Z">
          2025-12-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><h3 id="require"><a href="#require" class="headerlink" title="require"></a>require</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">导入宏, 否则不能调用宏的方法</span><br></pre></td></tr></table></figure>

<h3 id="use"><a href="#use" class="headerlink" title="use"></a>use</h3><p>给模块动态增加方法</p>
<p>相当于</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">require XXX</span><br><span class="line">XXX.__using__</span><br></pre></td></tr></table></figure>

<h3 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h3><p>生成当前表达式的语法树，必须要在 defmacro 语句的里面才能用</p>
<h3 id="unquote"><a href="#unquote" class="headerlink" title="unquote"></a>unquote</h3><p>说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把 语法树转换为实际表达式，一般和 `quote` 一起组合成为新的 ast，必须在宏里面才能用</span><br></pre></td></tr></table></figure>

<p>使用场景</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defmacro 关键字修饰的函数参数，如果要使用它作为变量，则需要 `unquote`</span><br></pre></td></tr></table></figure>

<h2 id="宏调试"><a href="#宏调试" class="headerlink" title="宏调试"></a>宏调试</h2><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">SimpleMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">plus</span></span>(ast_x, ast_y) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">unquote</span>(ast_x) + <span class="keyword">unquote</span>(ast_y)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">ast =</span><br><span class="line">  <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">    <span class="title class_">SimpleMacro</span>.plus(x, <span class="number">23</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">ast |&gt; <span class="title class_">Macro</span>.expand(__ENV__) |&gt; <span class="title class_">Macro</span>.to_string</span><br></pre></td></tr></table></figure>

<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><h3 id="普通例子"><a href="#普通例子" class="headerlink" title="普通例子"></a>普通例子</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">plus</span></span>(ast_x, ast_y) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">unquote</span>(ast_x) + <span class="keyword">unquote</span>(ast_y)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="title class_">DemoMacro</span></span><br><span class="line"><span class="title class_">DemoMacro</span>.plus(<span class="number">11</span>,<span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<h3 id="bind-quoted"><a href="#bind-quoted" class="headerlink" title="bind_quoted"></a>bind_quoted</h3><p>bind_quoted 绑定的值会保持不变</p>
<p>代码如下</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">require</span> <span class="title class_">Logger</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">double_puts</span></span>(expr) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="title class_">Logger</span>.debug(<span class="keyword">unquote</span>(expr))</span><br><span class="line">      <span class="title class_">Logger</span>.debug(<span class="keyword">unquote</span>(expr))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">require</span> <span class="title class_">Logger</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">double_puts</span></span>(expr) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="symbol">bind_quoted:</span> [<span class="symbol">aaa:</span> expr] <span class="keyword">do</span></span><br><span class="line">      <span class="title class_">Logger</span>.debug(aaa)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="title class_">DemoMacro</span></span><br><span class="line"><span class="title class_">DemoMacro</span>.double_puts(<span class="symbol">:os</span>.system_time)</span><br></pre></td></tr></table></figure>

<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p><a target="_blank" rel="noopener" href="https://blog.appsignal.com/2021/10/26/how-to-use-macros-in-elixir.html">参考链接</a></p>
<h3 id="动态添加方法和属性"><a href="#动态添加方法和属性" class="headerlink" title="动态添加方法和属性"></a>动态添加方法和属性</h3><p>use 模块除了在模块调用 <code>__using__</code> 宏外, 不做其他任何事情</p>
<p>注意 <code>require</code> 的位置</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">demo</span></span>(name) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">unquote</span>(name) &lt;&gt; <span class="string">&quot;, &quot;</span> &lt;&gt; <span class="string">&quot;in DemoMacro&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoUsing</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(opts) <span class="keyword">do</span></span><br><span class="line">    params = <span class="title class_">Keyword</span>.get(opts, <span class="symbol">:aaa</span>, <span class="string">&quot;default params&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">require</span> <span class="title class_">DemoMacro</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">demo</span></span>(name) <span class="keyword">do</span></span><br><span class="line">        value = <span class="string">&quot;value from &quot;</span> &lt;&gt; <span class="keyword">unquote</span>(params) &lt;&gt; <span class="string">&quot;, &quot;</span> &lt;&gt; name</span><br><span class="line">        <span class="title class_">DemoMacro</span>.demo(value)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">DemoUsing</span>, <span class="symbol">aaa:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Demo</span>.demo(<span class="string">&quot;me&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="方法重写"><a href="#方法重写" class="headerlink" title="方法重写"></a>方法重写</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoUsing</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(_opts) <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test1</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">        x + y</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">test2</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">        x - y</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      defoverridable <span class="symbol">test1:</span> <span class="number">2</span>, <span class="symbol">test2:</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">DemoUsing</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test1</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 调用默认实现</span></span><br><span class="line">    super(x, y)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test2</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">    x * y * y</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Demo</span>.test1(<span class="number">11</span>, <span class="number">22</span>)</span><br><span class="line"><span class="title class_">Demo</span>.test2(<span class="number">11</span>, <span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<h3 id="behaviour-重写"><a href="#behaviour-重写" class="headerlink" title="behaviour 重写"></a>behaviour 重写</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoBehaviour</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="variable">@callback</span> demo(number(), number()) :: number()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># defoverridable 使用 Behaviour 当参数的时候，所有 callback 都可以被 override</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoUsing</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">require</span> <span class="title class_">Logger</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(_opts) <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="variable">@behaviour</span> <span class="title class_">DemoBehaviour</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">demo</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">        <span class="title class_">Logger</span>.debug(<span class="string">&quot;default in DemoBehaviour&quot;</span>)</span><br><span class="line">        x + y</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      defoverridable <span class="title class_">DemoBehaviour</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">require</span> <span class="title class_">Logger</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">DemoUsing</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">demo</span></span>(x, y) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># super(x, y)</span></span><br><span class="line">    <span class="title class_">Logger</span>.debug(<span class="string">&quot;override in DemoBehaviour&quot;</span>)</span><br><span class="line">    x * y</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Demo</span>.demo(<span class="number">11</span>, <span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<h3 id="动态生成常量"><a href="#动态生成常量" class="headerlink" title="动态生成常量"></a>动态生成常量</h3><p>模块编译完成以后，会打印 [“henry”, “john”]</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoMacro</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">add</span></span>(name) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="variable">@names</span> <span class="keyword">unquote</span>(name)</span><br><span class="line">      <span class="symbol">:ok</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">require</span> <span class="title class_">DemoMacro</span></span><br><span class="line">  <span class="keyword">import</span> <span class="title class_">DemoMacro</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">Module</span>.register_attribute(__MODULE__, <span class="symbol">:names</span>, <span class="symbol">accumulate:</span> <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  add <span class="string">&quot;john&quot;</span></span><br><span class="line">  add <span class="string">&quot;henry&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="title class_">IO</span>.inspect(<span class="variable">@names</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="修改属性"><a href="#修改属性" class="headerlink" title="修改属性"></a>修改属性</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoUsing</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(_) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="title class_">Module</span>.register_attribute(__MODULE__, <span class="symbol">:xxx</span>, <span class="symbol">accumulate:</span> <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">show</span></span>(name) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="title class_">IO</span>.inspect(<span class="string">&quot;<span class="subst">#&#123;<span class="keyword">unquote</span>(name)&#125;</span> <span class="subst">#&#123;<span class="variable">@xxx</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">DemoUsing</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@xxx</span> <span class="string">&quot;测试&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">aaa</span></span>() <span class="keyword">do</span></span><br><span class="line">    <span class="title class_">DemoUsing</span>.show(<span class="string">&quot;123&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="编译期-hook"><a href="#编译期-hook" class="headerlink" title="编译期 hook"></a>编译期 hook</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">DemoUsing</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(_) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="variable">@before_compile</span> <span class="keyword">unquote</span>(__MODULE__)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__before_compile__</span></span>(env) <span class="keyword">do</span></span><br><span class="line">    <span class="title class_">IO</span>.inspect(env)</span><br><span class="line">    <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Demo</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">DemoUsing</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="模拟-test"><a href="#模拟-test" class="headerlink" title="模拟 test"></a>模拟 test</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Calculator</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(a, b), <span class="symbol">do:</span> a + b</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">subtract</span></span>(a, b), <span class="symbol">do:</span> a - b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">TestCase</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__using__</span></span>(_) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">require</span> <span class="title class_">Logger</span></span><br><span class="line">      <span class="keyword">import</span> <span class="title class_">TestCase</span></span><br><span class="line">      <span class="title class_">Module</span>.register_attribute(__MODULE__, <span class="symbol">:tests</span>, <span class="symbol">accumulate:</span> <span class="literal">true</span>)</span><br><span class="line">      <span class="variable">@before_compile</span> <span class="keyword">unquote</span>(__MODULE__)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">__before_compile__</span></span>(_env) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Inject a run function into the test case after all tests have been accumulated</span></span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">run</span></span> <span class="keyword">do</span></span><br><span class="line">        <span class="title class_">Enum</span>.each <span class="variable">@tests</span>, <span class="keyword">fn</span> test_name -&gt;</span><br><span class="line">          result = apply(__MODULE__, test_name, [])</span><br><span class="line">          state = <span class="keyword">if</span> result, <span class="symbol">do:</span> <span class="string">&quot;pass&quot;</span>, <span class="symbol">else:</span> <span class="string">&quot;fail&quot;</span></span><br><span class="line">          <span class="title class_">Logger</span>.debug(<span class="string">&quot;<span class="subst">#&#123;test_name&#125;</span> =&gt; <span class="subst">#&#123;state&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defmacro</span> <span class="title">test</span></span>(description, <span class="symbol">do:</span> body) <span class="keyword">do</span></span><br><span class="line">    test_name = <span class="title class_">String</span>.to_atom(description)</span><br><span class="line">    <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">      <span class="variable">@tests</span> <span class="keyword">unquote</span>(test_name)</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">unquote</span></span>(test_name)(), <span class="symbol">do:</span> <span class="keyword">unquote</span>(body)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">CalculatorTest</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> <span class="title class_">TestCase</span></span><br><span class="line">  <span class="keyword">import</span> <span class="title class_">Calculator</span></span><br><span class="line"></span><br><span class="line">  test <span class="string">&quot;add 1, 2 should return 3&quot;</span> <span class="keyword">do</span></span><br><span class="line">    add(<span class="number">1</span>, <span class="number">2</span>) == <span class="number">3</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  test <span class="string">&quot;subtract 5, 2 should not return 4&quot;</span> <span class="keyword">do</span></span><br><span class="line">    subtract(<span class="number">5</span>, <span class="number">2</span>) == <span class="number">4</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">CalculatorTest</span>.run</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/elixir/">elixir</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2025 John Doe
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>